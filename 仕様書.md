# 日商簿記3級 仕訳問題アプリ - 仕様書

## 1. アプリケーション概要

### 1.1 目的
日商簿記3級検定対策として、制限時間内に仕訳問題を解く練習を行うWebアプリケーション。

### 1.2 主要機能
- 15分以内に15問の仕訳問題を解答
- タイマー機能（カウントダウン）
- 正誤判定機能
- 正解・解説表示
- AI APIによる高品質な問題の自動生成（Claude/Groq/Gemini対応）
- AIプロバイダー切り替え機能（UIから選択可能）
- 自動リトライ機能（エラー学習機能付き）
- 部分成功対応（一部の問題のみ取得できた場合も表示）

### 1.3 対象ユーザー
- 日商簿記3級の受験者
- 簿記の基礎を学習中の学生・社会人

---

## 2. 技術スタック

### 2.1 フロントエンド
- **フレームワーク**: Next.js 15.x (App Router)
- **UI**: React 18.x (関数コンポーネント)
- **言語**: TypeScript
- **スタイリング**: Tailwind CSS

### 2.2 バックエンド
- **API**: Next.js API Routes
- **外部AI API**:
  - **Claude API** (claude-3-5-haiku-20241022) - **推奨・高品質、UIデフォルト**
  - Groq API (llama-3.3-70b-versatile) - 無料・高速
  - Google Gemini API (gemini-2.5-flash) - 無料・バックアップ
  - UIから選択可能（Claude/Groq/Gemini）、環境変数でも切り替え可能
- **プロンプト管理**: `prompts/bookkeeping-prompt.ts`（編集しやすい独立ファイル）

### 2.3 データ管理
- **問題データ**: ローカルJSON / Gemini API生成
- **状態管理**: React Hooks (useState, useEffect)
- **永続化**: sessionStorage

### 2.4 デプロイ
- **ホスティング**: Vercel
- **リポジトリ**: GitHub

---

## 3. 機能仕様

### 3.1 タイマー機能

#### 3.1.1 制限時間設定
- デフォルト: 15分
- 変更可能: 1分～999分
- 実行中は変更不可

#### 3.1.2 タイマー制御
| ボタン | 機能 | 状態 |
|--------|------|------|
| Start | タイマー開始 | 停止中のみ有効 |
| Stop | タイマー停止 | 実行中のみ有効 |
| Reset | タイマーリセット | 常に有効 |

#### 3.1.3 時間切れ処理
- 残り時間が0秒になると自動的にアラート表示
- タイマーは自動停止
- アラートメッセージ: 「時間切れです！」

### 3.2 問題表示機能

#### 3.2.1 問題構成
各問題は以下の要素で構成:
- 問題番号（1～15）
- 問題文
- 勘定科目選択肢（A, B, C, D の4つ）
- 回答入力欄
  - 借方記号（A-D）
  - 借方金額（数値）
  - 貸方記号（A-D）
  - 貸方金額（数値）

#### 3.2.2 入力仕様
- 記号入力: 自動で大文字変換
- 金額入力: 数値のみ
- 入力データは自動保存（sessionStorage）

### 3.3 判定機能

#### 3.3.1 個別判定
- 各問題の「判定」ボタンをクリック
- 正解: ○ 正解（緑色）
- 不正解: × 不正解（赤色）
- 未入力: 判定なし

#### 3.3.2 全問題判定
- 「全問題を判定」ボタンをクリック
- 全15問を一括判定
- 正解数をアラートで表示
  - 例: 「判定完了！ 12 / 15 問正解」

#### 3.3.3 判定ロジック
以下の条件を全て満たす場合に正解:
1. 借方記号が正解と一致
2. 借方金額が正解と一致
3. 貸方記号が正解と一致
4. 貸方金額が正解と一致

未入力がある場合は判定対象外。

### 3.4 正解・解説表示機能

#### 3.4.1 遷移
- 各問題の「正解」ボタンをクリック
- 別ページに遷移

#### 3.4.2 表示内容
- 問題文
- 正解の仕訳（表形式）
  - 借方勘定科目・金額
  - 貸方勘定科目・金額
- 解説文
- 「問題一覧に戻る」ボタン

#### 3.4.3 データ保持
- 正解ページから戻った際も入力データは保持される

### 3.5 問題更新機能

#### 3.5.1 問題生成
- 「問題の更新」ボタンをクリック
- AI API（Claude、Groq、または Gemini）を呼び出して新しい15問を生成
- 生成中は「更新中...」と表示（ローディングスピナー付き）
- ボタンは無効化
- **リトライ機能**: 設定された回数（1～10回、デフォルト3回）まで自動的に再試行
- **エラー学習**: 前回の試行で発生したエラーをAIに通知し、同じミスを防止
- **部分成功対応**: 15問中一部のみ有効な場合、取得できた問題だけを表示

#### 3.5.2 問題の難易度と構成
生成される15問の内訳：
- **標準レベル**: 12問
- **応用レベル（複雑・長文）**: 3問

問題文の特徴：
- 標準問題：明確で具体的な記述
- 応用問題：複雑で長文、複数のステップや条件を含む

#### 3.5.3 必須問題タイプ
以下の問題タイプが必ず含まれます：
- **減価償却**: 2問以上
- **経過勘定**（前払費用、未払費用、前受収益、未収収益）: 2問以上
- **貸倒引当金**: 1問以上
- **固定資産の購入・売却**: 1問以上
- **その他の基本取引**: 残りの問題

#### 3.5.4 成功時
- 問題を新しいものに差し替え
- 回答・判定結果をクリア
- アラート表示: 「問題を更新しました！」

#### 3.5.5 部分成功時
- 15問中一部のみ有効な問題が生成された場合
- 有効な問題のみを表示（例: 14問のみ取得）
- アラート表示: 「14問取得しました（15問中）」+ 取得できなかった問題番号
- 回答・判定結果をクリア

#### 3.5.6 失敗時
- 既存の問題は維持
- アラート表示: 「更新できません」
- エラー原因とメッセージ:
  - **検証エラー (422)**: 「AIが生成した問題に不備がありました。別のAIプロバイダーを試すか、もう一度「問題の更新」をクリックしてください。」
  - **クォータ超過 (429)**: 「APIのクォータ制限に達しました。無料枠は1日20リクエストまでです。」
  - **サーバー過負荷 (503)**: 「Gemini APIサーバーが混雑しています。数分待ってから再度お試しください。」
  - **タイムアウト (408)**: 「リクエストがタイムアウトしました。もう一度お試しください。」
  - **その他**: 「更新できません。ネットワークまたはAPIキーを確認してください。」

#### 3.5.7 AIプロバイダー選択
- 「問題の更新」ボタンの下にセレクトボックスを配置
- 選択可能なプロバイダー：
  - **Claude (推奨・高品質)**: デフォルト選択、最も高品質な問題を生成
  - **Groq (無料)**: 高速、無料で利用可能
  - **Gemini (無料)**: バックアップ、無料で利用可能
- 選択されたプロバイダーでAPIを呼び出す
- リアルタイムで切り替え可能

#### 3.5.8 リトライ回数設定
- AIプロバイダー選択の下に数値入力欄を配置
- 設定可能範囲: 1～10回
- デフォルト: 3回
- 推奨値: 3～5回
- 設定した回数まで問題生成を自動的に再試行
- リトライ回数が多いほど成功確率が高まるが、待ち時間も増加

#### 3.5.9 問題生成の品質管理

**仕訳の基本ルール:**
- 資産・負債・純資産・収益・費用の性質に基づいて借方・貸方を正しく判断
- 借方・貸方を絶対に逆にしない

**取引時と決算時の処理区分:**
- 取引時（期中）は、原則として収益または費用の勘定科目で処理
- 前払費用・未払費用・未収収益・前受収益は、決算整理で計上
- 取引時に「前払費用」等で処理しない

**商品売買の処理方法:**
- 必ず三分法で処理（仕入、売上、繰越商品）
- 分記法や総記法は使用しない

**減価償却:**
- 必ず定額法を使用
- 定率法や生産高比例法は使用しない

**勘定科目の表記ルール:**
- ガス代、水道代、電気代 → 水道光熱費
- 家具 → 備品
- 減価償却累計額は固定資産ごとに明記（例：機械減価償却累計額）

**重複防止:**
- 15問は全て異なる取引タイプ
- 同じような問題を複数出題しない

### 3.6 解答クリア機能
- 「解答クリア」ボタンをクリック
- 全ての入力データをクリア
- 全ての判定結果をクリア
- 問題はそのまま維持

---

## 4. 画面仕様

### 4.1 レイアウト構成

```
┌─────────────────────────────────────────┐
│ [左サイドバー]    │ [メインコンテンツ]  │
│ (固定)            │ (スクロール可能)    │
│                   │                      │
│ ■ タイマー設定    │ ■ 問題1              │
│ ■ Start/Stop/Reset│ ■ 問題2              │
│ ■ 残り時間表示    │ ■ 問題3              │
│                   │  ...                 │
│ ─────────────     │ ■ 問題15             │
│ ■ 全問題を判定    │                      │
│ ■ 解答クリア      │                      │
│ ■ 問題の更新      │                      │
└─────────────────────────────────────────┘
```

### 4.2 左サイドバー（固定）

#### サイズ
- 幅: 320px (20rem)
- 高さ: 画面全体
- 背景: 白色
- 右ボーダー: グレー

#### 要素
1. **タイトル**: 「タイマー・判定」
2. **制限時間入力欄**
   - ラベル: 制限時間（分）
   - 入力: number型
   - デフォルト: 15
3. **タイマー制御ボタン**
   - Start（緑）/ Stop（黄）/ Reset（グレー）
   - 3つ横並び
4. **残り時間表示**
   - フォーマット: mm:ss
   - フォントサイズ: 大きめ
5. **全問題を判定ボタン**（紫色）
6. **解答クリアボタン**（赤色）
7. **問題の更新ボタン**（青色）
8. **AIプロバイダー選択ボックス**
   - ラベル: AIプロバイダー
   - 選択肢: Claude (推奨・高品質)、Groq (無料)、Gemini (無料)
   - デフォルト: Claude
9. **リトライ回数入力欄**
   - ラベル: リトライ回数
   - 入力: number型（1～10）
   - デフォルト: 3
   - 説明: 1〜10回（推奨: 3〜5回）

### 4.3 メインコンテンツ

#### レイアウト
- 左マージン: 320px（サイドバー分）
- パディング: 2rem
- 背景: グレー

#### 各問題カード
- 白背景
- ボーダー: グレー
- パディング: 1rem
- マージン下: 1rem
- 角丸

**構成:**
1. 問題番号（太字）
2. 問題文
3. 勘定科目一覧（横並び）
4. 借方・貸方入力欄（2列グリッド）
5. ボタン群（判定・正解）+ 判定結果表示

### 4.4 正解・解説ページ

#### レイアウト
- 最大幅: 768px
- 中央寄せ
- パディング: 2rem

#### 構成
1. **タイトル**: 問題X - 解答・解説
2. **問題セクション**
   - 見出し: 「問題」
   - 問題文表示
3. **正解の仕訳セクション**
   - 見出し: 「正解の仕訳」
   - テーブル形式
     | 借方 | 金額 | 貸方 | 金額 |
4. **解説セクション**
   - 見出し: 「解説」
   - 解説文
5. **戻るボタン**（青色）

---

## 5. API仕様

### 5.1 問題生成API

#### エンドポイント
```
POST /api/generate-problems
```

#### リクエスト
```json
{
  "provider": "claude" | "groq" | "gemini",  // 使用するAIプロバイダー（省略時: 環境変数から取得）
  "maxRetries": 3  // リトライ回数（1～10、省略時: 3）
}
```

#### レスポンス

**完全成功時（200）:**
```json
{
  "problems": [
    {
      "id": 1,
      "question": "問題文",
      "accountOptions": [
        { "symbol": "A", "name": "勘定科目名" }
      ],
      "correctAnswer": {
        "debitSymbol": "A",
        "debitAmount": 100000,
        "creditSymbol": "B",
        "creditAmount": 100000
      },
      "explanation": "解説文"
    }
    // ... 15問
  ]
}
```

**部分成功時（200）:**
```json
{
  "problems": [/* 取得できた問題のみ */],
  "partial": true,
  "totalRequested": 15,
  "totalObtained": 14,
  "invalidProblems": [7],  // 取得できなかった問題番号
  "message": "14問取得しました（15問中）"
}
```

**検証エラー時（422）:**
```json
{
  "error": "generated_validation_failed",
  "message": "AIが生成した問題に不備がありました（X件のエラー、Y回試行）。もう一度試すか、別のAIプロバイダーを選択してください。",
  "details": ["問題7: 借方金額と貸方金額が一致していません"],
  "provider": "claude",
  "attempts": 3
}
```

**その他エラー時（500, 408, 429, 503）:**
```json
{
  "error": "エラータイプ",
  "details": "エラー詳細"
}
```

#### 外部API呼び出し
- **URL**: `https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent`
- **メソッド**: POST
- **認証**: クエリパラメータでAPIキー送信

**プロンプト仕様:**
- 日商簿記3級の仕訳問題を15問生成
- 各問題に4つの勘定科目選択肢
- JSON形式で出力
- 問題ID: 1～15

### 5.2 テストAPI（開発用）

#### エンドポイント
```
GET /api/test-gemini
```

#### 機能
- 利用可能なモデル一覧取得
- 簡単なテストリクエスト実行

#### レスポンス
```json
{
  "apiKey": "AIza...",
  "tests": {
    "listModels": { "success": true, "models": [...] },
    "geminiPro": { "success": false, ... },
    "gemini15Flash": { "success": false, ... }
  }
}
```

---

## 6. データ構造

### 6.1 型定義（TypeScript）

```typescript
// 勘定科目選択肢
interface AccountOption {
  symbol: string;  // A, B, C, D
  name: string;    // 勘定科目名
}

// 仕訳エントリ
interface JournalEntry {
  debitSymbol: string;   // 借方記号
  debitAmount: number;   // 借方金額
  creditSymbol: string;  // 貸方記号
  creditAmount: number;  // 貸方金額
}

// 問題
interface Problem {
  id: number;                        // 問題番号 1-15
  question: string;                  // 問題文
  accountOptions: AccountOption[];   // 勘定科目選択肢（4つ）
  correctAnswer: JournalEntry;       // 正解
  explanation: string;               // 解説
}

// ユーザー回答
interface UserAnswer {
  debitSymbol: string;   // 借方記号（入力値）
  debitAmount: string;   // 借方金額（入力値）
  creditSymbol: string;  // 貸方記号（入力値）
  creditAmount: string;  // 貸方金額（入力値）
}

// 判定結果
type JudgementResult = 'correct' | 'incorrect' | null;
```

### 6.2 デフォルト問題データ

**ファイル:** `data/problems.json`

**内容:**
- 15問の仕訳問題
- 現金取引中心
- 基本的な勘定科目を使用

### 6.3 sessionStorage

**保存データ:**
- `answers`: ユーザーの回答データ（JSON配列）
- `judgements`: 判定結果（JSON配列）

**ライフサイクル:**
- タブを閉じるまで保持
- リロードしても保持
- 別タブでは共有されない

---

## 7. 環境変数

### 7.1 必須環境変数

```bash
# AIプロバイダーの選択 (claude, groq, または gemini)
# 注意: UI からも選択可能なため、この設定は省略可能
AI_PROVIDER=claude

# Claude API Key (推奨・高品質、UIデフォルト)
CLAUDE_API_KEY=your_claude_api_key

# Groq API Key (無料・高速)
GROQ_API_KEY=your_groq_api_key

# Gemini API Key (無料・バックアップ)
GEMINI_API_KEY=your_gemini_api_key
```

### 7.2 AIプロバイダーの選択

#### Claude（推奨・高品質）
```bash
AI_PROVIDER=claude
```
- **料金**: 初回 $5 のクレジット購入が必要（従量課金制）
- **コスト**: 約0.1～0.3円/問題生成（15問で1.5～4.5円程度）
- **レスポンス速度**: 高速
- **安定性**: 非常に高い
- **品質**: 最も高品質（計算ミスが少なく、仕訳の精度が高い）
- **APIキー取得**: https://console.anthropic.com/
- **モデル**: claude-3-5-haiku-20241022
- **推奨理由**: 問題の品質が最も高く、リトライ成功率が高い

#### Groq（無料・高速）
```bash
AI_PROVIDER=groq
```
- **1日あたり**: 14,400リクエスト
- **レスポンス速度**: 非常に高速
- **安定性**: 高い（503エラーが少ない）
- **品質**: 良好（計算ミスが時々発生）
- **APIキー取得**: https://console.groq.com （無料、クレカ不要）
- **モデル**: llama-3.3-70b-versatile

#### Gemini（無料・バックアップ）
```bash
AI_PROVIDER=gemini
```
- **1日あたり**: 20リクエスト
- **レスポンス速度**: 標準
- **安定性**: 中（503エラーが発生しやすい）
- **品質**: 良好（計算ミスが時々発生）
- **APIキー取得**: https://ai.google.dev/
- **モデル**: gemini-2.5-flash

### 7.3 設定方法

#### ローカル開発
`.env.local` ファイルに記述（`.env.local.example`を参考）

#### Vercel
- プロジェクト設定 > Environment Variables
- 以下を設定:
  - `AI_PROVIDER`: `claude`、`groq`、または `gemini`（省略可能、UI から選択可能）
  - `CLAUDE_API_KEY`: ClaudeのAPIキー（推奨）
  - `GROQ_API_KEY`: GroqのAPIキー（無料・バックアップ）
  - `GEMINI_API_KEY`: GeminiのAPIキー（無料・バックアップ）

詳細は `AI_PROVIDER_SETUP.md` を参照

### 7.4 プロンプト設定
- **ファイル**: `prompts/bookkeeping-prompt.ts`
- **目的**: AI問題生成のプロンプトを独立ファイルで管理
- **編集方法**: ファイルを直接編集（変更後はサーバー再起動が必要）
- **内容**: 問題構成、仕訳ルール、月割計算ルール、金額整合性要件など

---

## 8. デプロイ仕様

### 8.1 ホスティング
- **プラットフォーム**: Vercel
- **ビルドコマンド**: `npm run build`
- **出力ディレクトリ**: `.next`

### 8.2 自動デプロイ
- GitHubのmainブランチへのpush時に自動デプロイ
- プレビューデプロイ: Pull Request作成時

### 8.3 本番URL
```
https://boki3-app.vercel.app
```

---

## 9. 制約事項

### 9.1 AI API制限（無料枠）

#### Groq API制限（推奨）
**llama-3.3-70b-versatile モデル**:
- 1分あたり: 30リクエスト (RPM)
- 1日あたり: **14,400リクエスト** (RPD)
- トークン: 6,000トークン/分 (TPM)
- クレジットカード: 不要

#### Gemini API制限（バックアップ）
**注意**: 2025年12月にGoogleが無料枠を大幅に削減しました。

**gemini-2.5-flash モデル**:
- 1分あたり: 10リクエスト (RPM)
- 1日あたり: **20リクエスト** (RPD) ※2025年12月変更
- トークン: 250,000トークン/分 (TPM)

**クォータリセット時刻**:
- 太平洋時間の0時（日本時間17時/冬時間、16時/夏時間）

**参考**: 以前は1日250リクエストでしたが、2025年12月7日の変更で20リクエストに削減されました。503エラー（サーバー過負荷）も発生しやすくなっています。

### 9.2 ブラウザ対応
- Chrome（推奨）
- Firefox
- Safari
- Edge

### 9.3 画面サイズ
- 最小幅: 1024px（推奨）
- レスポンシブデザイン未対応

---

## 10. 今後の拡張案

### 10.1 機能拡張
- [ ] 問題の難易度選択
- [ ] 学習履歴の保存
- [ ] 正解率の統計表示
- [ ] 複数の試験種別対応（2級、1級）
- [ ] 問題のお気に入り機能

### 10.2 UI改善
- [ ] レスポンシブデザイン対応
- [ ] ダークモード対応
- [ ] キーボードショートカット
- [ ] アクセシビリティ向上

### 10.3 技術改善
- [ ] データベース導入（ユーザー管理）
- [ ] 認証機能（ログイン）
- [ ] PWA化（オフライン対応）
- [ ] テストコード追加

---

## 11. バージョン履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0.0 | 2025-XX-XX | 初回リリース |
| 1.1.0 | 2025-12-17 | Groq API対応、問題生成の強化 |
| 1.2.0 | 2025-12-18 | 問題生成品質の大幅改善、Claude API統合 |
| 1.3.0 | 2025-12-19 | リトライ機能強化、部分成功対応、プロンプト独立化 |

### v1.3.0の主な変更点（2025-12-19）

**Claude APIを推奨プロバイダーに変更:**
- UIデフォルトをClaudeに変更（最も高品質な問題生成）
- Groq、Geminiは無料バックアップとして継続サポート

**リトライ機能の大幅強化:**
- リトライ回数をUIから設定可能（1～10回、デフォルト3回）
- エラー学習機能: 前回の試行で発生したエラーをAIに通知し、同じミスを防止
- エラーコンテキストを次の試行に渡すことで、リトライ成功率が向上

**部分成功対応:**
- 15問中一部のみ有効な問題が生成された場合、取得できた問題だけを表示
- 「14問取得しました（15問中）」のようなメッセージを表示
- 取得できなかった問題番号を通知

**プロンプト管理の改善:**
- プロンプトを`prompts/bookkeeping-prompt.ts`に独立化
- プロンプト編集が容易に（ファイル内で直接編集可能）
- 変更後はサーバー再起動のみで反映

**検証ロジックの強化:**
- 問題ごとの個別検証を実装
- 無効な問題を除外して有効な問題のみ返却
- 詳細なエラーメッセージ（どの問題のどこが間違っているか明示）

**API仕様の拡張:**
- リクエストに`maxRetries`パラメータを追加
- レスポンスに部分成功フィールド（`partial`, `invalidProblems`など）を追加
- 422エラー（検証エラー）の詳細情報を返却

### v1.2.0の主な変更点
**問題生成品質の改善:**
- プロンプトを大幅改善（問題文の明確化、曖昧さの排除）
- 仕訳の基本ルールを追加（借方・貸方の誤りを防止）
- 取引時と決算時の処理区分を明確化
- 商品売買を三分法に統一
- 減価償却を定額法に統一
- 勘定科目の表記ルールを統一（水道光熱費、備品、減価償却累計額など）
- 重複問題の防止機能追加

**難易度と出題構成:**
- 難易度配分を変更：標準12問、応用3問（基礎レベルを廃止）
- 問題文を複雑で長文に（複数の条件を含める）
- 応用問題は特に長文で複数のステップを含む

**AI機能:**
- UIからのAIプロバイダー切り替え機能追加（Groq/Gemini）
- Claude API統合（バックエンド対応済み、UI 非表示）
- リアルタイムでプロバイダー切り替え可能

### v1.1.0の主な変更点
- Groq API対応（1日14,400リクエスト）
- AIプロバイダー切り替え機能（環境変数）
- 難易度別問題生成（基礎5問、標準7問、応用3問）
- 必須問題タイプの指定（減価償却、経過勘定など）
- ローディングスピナー追加
- エラーメッセージの改善
- 初回アクセス時の自動問題更新
- 金額のカンマ区切り表示

---

## 12. ライセンス

Private

## 13. 連絡先

GitHub: https://github.com/koji0505/boki3-app
